# Developer Manual

## List of CKAN documatations required to understand
- [How to create an empty CKAN plugin](https://docs.ckan.org/en/latest/extensions/tutorial.html)
- [CKAN Theming & Jinja2 template Guide](https://docs.ckan.org/en/latest/theming/templates.html)
- [Extending CKAN schema](https://docs.ckan.org/en/latest/extensions/adding-custom-fields.html)
- [Adding custom config in plugin](https://docs.ckan.org/en/2.10/extensions/custom-config-settings.html?highlight=config%20declaration)
- [Make config runtime editable](https://docs.ckan.org/en/2.10/extensions/remote-config-update.html)


---
## Setup environment for development

### System requirements for developing CKAN plugin
- **Ubuntu 22.04** or newer: To align with offcial CKAN documentation, Ubuntu 22.04 or newer is required, Windows/Mac OS will simply not work or have a lot of issues.
- Have **root privilege**

### Install CKAN
- Prepare environment: 
    ```shell
    sudo apt update
    sudo apt install build-essential
    ```
- [Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/)
  - follow the guide to install the latest version, don't install it from `apt` nor `snap`
- Follow the [official guide "Installing CKAN from sourceÂ¶"](https://docs.ckan.org/en/latest/maintaining/installing/install-from-source.html): 
- [Create a sysadmin account](https://docs.ckan.org/en/2.10/maintaining/getting-started.html#create-admin-user)
- You may want to modify the CKAN cofig: `/etc/ckan/default/ckan.ini`, i.e. extend logged in session
- You should be able to start CKAN:
    ```shell
    . /usr/lib/ckan/default/bin/activate
    ckan -c /etc/ckan/default/ckan.ini run

    # You may want to set the environment variable `WERKZEUG_DEBUG_PIN` to enable debugging in browser.
    # This sets the debug PIN to 123456 and run ckan
    # WERKZEUG_DEBUG_PIN=123456 ckan -c /etc/ckan/default/ckan.ini run
    ```

### Install ckanext-udc plugin
```shell
# Activate the virtual env
. /usr/lib/ckan/default/bin/activate

# Go to ckan's source directory
cd /usr/lib/ckan/default/src

# Download the UDC plugin
git clone https://github.com/csse-uoft/ckanext-udc

# Install dependencies
cd ./ckanext-udc
pip install -e .
pip install -r requirements.txt
```

### Activate the UDC plugin
Add `udc` to the `ckan.plugins` setting in your CKAN config file (by default the config file is located at /etc/ckan/default/ckan.ini).
```shell
nano /etc/ckan/default/ckan.ini
```
Look for `ckan.plugins`
```ini
...
## Plugins Settings ############################################################
ckan.plugins = activity
ckan.resource_proxy.timeout = 5
...
```
Add `udc` to `ckan.plugins`:
```ini
...
## Plugins Settings ############################################################
ckan.plugins = activity udc
ckan.resource_proxy.timeout = 5
...
```

#### Change `dataset` to `catalogue`
Look for `ckan.default.package_type`
```ini
## Theming Settings ############################################################
...
ckan.default.package_type = catalogue
```
  
## Understand the basic structure of UDC plugin
```
ðŸ“¦ckanext-udc
 â”£ ðŸ“‚ckanext
 â”ƒ â”£ ðŸ“‚udc
 â”ƒ â”ƒ â”£ ðŸ“‚assets         <- Public files that will pass to the browser
 â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚js
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œpackage.js
 â”ƒ â”ƒ â”ƒ â”— ðŸ“œwebassets.yml
 â”ƒ â”ƒ â”£ ðŸ“‚templates      <- Jinja2 templates (overrided templates & new templates)
 â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚admin
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œconfig.html
 â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚package
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚macros
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œckan_fields.html
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“‚snippets
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œadditional_info.html
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œpackage_basic_information.html
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œpackage_custom_fields.html
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“œpackage_form.html
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œpackage_metadata_fields.html
 â”ƒ â”ƒ â”£ ðŸ“œ__init__.py
 â”ƒ â”ƒ â”— ðŸ“œplugin.py     <- Main Plugin Entrance.
 â”ƒ â”— ðŸ“œ__init__.py
 â”£ ðŸ“œsetup.py          <- How this python package should be installed. Invoked by `pip install ...`
```
### Template overrides
Every CKAN page is generated by rendering a particular template. For each page of a CKAN site thereâ€™s a corresponding template file. For example the front page is generated from the [ckan/templates/home/index.html](https://github.com/ckan/ckan/blob/master/ckan/templates/home/index.html) file, the /about page is generated from [ckan/templates/home/about.html](https://github.com/ckan/ckan/blob/master/ckan/templates/home/about.html).

To customize pages, our plugin needs to register its own custom template directory containing template files that override the default ones. 

```py
class UDCPlugin(plugins.SingletonPlugin):
    # Declare that this class implements IConfigurer.
    plugins.implements(plugins.IConfigurer)

    def update_config(self, config: CKANConfig):
        toolkit.add_template_directory(config, 'templates')
```

CKAN will call this method when it starts up, to give our plugin a chance to modify CKANâ€™s configuration settings. Our `update_config()` method calls `add_template_directory()` to register its custom template directory with CKAN. This tells CKAN to look for template files in `ckanext-udc/ckanext/udc/templates` whenever it renders a page. **Any template file in this directory that has the same name as one of CKANâ€™s default template files, will be used instead of the default file.**

### Extend CKAN Schema
TODO
### Add custom config & Make config runtime editable
TODO
