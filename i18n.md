# Multilingual Design

## Storing multilingual fields
CKAN core fields are **not** multilingual. To keep backward compatibility, we do two things:

1. **Core fields** (`title`, `notes`/`description`, `tags`):
  - Keep the core field as a single string (default locale).
  - Store the multilingual versions in a sibling field with a `_translated` suffix, as JSON.
  - On input, the default locale from `<field>_translated` is copied to the core field so CKAN’s UI, API clients and Solr stay happy.
  - On output, we always return `<field>_translated` (seeding it from the core field if it was missing).

    ```json
    {
        "title": "My Dataset",
        "title_translated": {
            "en": "My Dataset",
            "fr": "Mon Jeu de Données"
        },
        "notes": "Short description in English.",
        "notes_translated": {
            "en": "Short description in English.",
            "fr": "Courte description en français."
        },
        "tags_translated": {
            "en": [{"name": "roads"}, {"name": "transport"}],
            "fr": [{"name": "routes"}, {"name": "transport"}]
        }
    }
    ```


2. **Custom maturity-model fields** (not used by CKAN core):

  * The field itself stores a `{lang: value}` object.
  * We keep the field name stable (no `_translated`), because nothing in core depends on it.

    ```json
    {
        "theme": {
            "en": "Water",
            "fr": "Eau"
        }
    }
      ```

## API compatibility
You can **send** and **receive** multilingual payloads without breaking non-multilingual clients.

* **Core CKAN fields**: send the usual core fields plus the optional `*_translated` JSON objects.
* **Custom fields**: send `{lang: value}` objects directly.

**Create/Update example (what you send)**
```json
{
    "title_translated": {
        "en": "My Dataset",
        "fr": "Mon Jeu de Données"
    },
    "theme": {
        "en": "Custom Value",
        "fr": "Valeur Personnalisée"
    },
    "tags_translated": {
        "en": [{"name": "water"}, {"name": "utilities"}, {"name": "valves"}],
        "fr": [{"name": "eau"}, {"name": "services"}, {"name": "vannes"}]
    }
}
```

**Show example (what you get back from GET /api/3/action/package_show)**
```json
{
    "title": "My Dataset",
    "title_translated": {
        "en": "My Dataset",
        "fr": "Mon Jeu de Données"
    },
    "theme": {
        "en": "Custom Value",
        "fr": "Valeur Personnalisée"
    },
    "tags_translated": {
        "en": [{"name": "water"}, {"name": "utilities"}, {"name": "valves"}],
        "fr": [{"name": "eau"}, {"name": "services"}, {"name": "vannes"}]
    }
}
```

##  Search & Solr compatibility

### Solr schema changes
To ensure Solr can index the multilingual fields, we need to define the fields in the Solr schema. We do this by running some scripts before the server starts or 
manually from the CLI.
```shell
ckan -c /etc/ckan/default/production.ini udc init-multilingual
```
TODO: The solr schema should not break the deduplication process when importing from other portals.
TODO: The actual solr changes/design should be documented here.

### Search behavior
When searching for datasets, the extension will search in the multilingual fields as well as the original fields. The search will return datasets that match the search term in any of the languages.

### Solr indexing

When an package is updated, the extension will override the Solr indexing process to ensure the multilingual fields are indexed correctly.

The extension will create a separate field for each language in the Solr schema. For example, the `title_translated` field will be indexed as `title_translated_en`. This helps the filter to do exact match on certain types of fields and blur search on others.

## Frontend compatibility
The UI shows a **language switcher** (EN/FR) that toggles which inputs are visible for **each** translatable field and allows switching **all fields in a level** at once.

<img width="500" height="500" alt="image" src="https://github.com/user-attachments/assets/7e99b700-73e1-47b1-9094-24e83fd6f60d" />


The default language is determined by the `ckan.locale_default` setting in the CKAN config file. The available languages are determined by the `ckan.locales_offered` setting in the CKAN config file.

When the user selects a display language for the web interface from the footer, the selected language will be used for the dataset fields as well.
<img width="400" height="257" alt="image" src="https://github.com/user-attachments/assets/2a9bb84b-3f60-4071-aa29-cdf57a53124b" />


# Configuration

Add to `ckan.ini`:

```ini
# Site default (also the default dataset language)
ckan.locale_default = en

# UI languages offered
ckan.locales_offered = en fr

# Dataset languages (subset of locales_offered; include default)
udc.multilingual.languages = en fr
```
> Ensure `udc.multilingual.languages` includes `ckan.locale_default`.

## Multilingual in the Maturity Model
To add multilingual support to a custom field in the maturity model, you need to define the field with the appropriate structure. Here is an example of how to define a multilingual field:
```json
 {
    "name": "theme",
    "label": {
        "en": "Domain / Topic",
        "fr": "Domaine / Sujet"
    },
    "type": "text",
    "short_description": {
        "en": "Domain or topic of the dataset being cataloged.",
        "fr": "Domaine ou sujet du jeu de données catalogué."
    },
    "long_description": {
        "en": "The theme or topic of the catalogue entry. Please select from an existing topic, such as Transportation, Housing, etc. Please refer to the taxonomy of topics available.",
        "fr": "Le thème ou le sujet de l'entrée du catalogue. Veuillez sélectionner un sujet existant, tel que les transports, le logement, etc. Veuillez vous référer à la taxonomie des sujets disponibles."
    },
    "category": "content"
},
```

