{% import 'macros/form.html' as form %}
{% import 'macros/locales.html' as locales with context %}
{% import 'package/macros/ckan_fields.html' as package_fields with context %}
{% set action = g.form_action or '' %}
{% set udc_langs = h.udc_languages or ['en'] %}
{% set default_lang = h.udc_default_lang or (udc_langs[0] if udc_langs else 'en') %}
{% set lang_labels = h.udc_language_labels or {} %}
{% set __lang = h.lang() or default_lang %}

{% asset 'udc/package-js'%}

<link rel="stylesheet" href="{{ h.url_for_static('/base/css/virtual-select.min.css') }}">
<script src="{{ h.url_for_static('/base/javascript/modules/virtual-select.min.js') }}" type="text/javascript"></script>

<form id="create-license-form"></form>

{# This provides a full page that renders a form for adding a dataset. It can
then itself be extended to add/remove blocks of functionality. #}
<form id="dataset-edit" method="post" action="{{ action }}" data-module="basic-form package-form" novalidate class="position-relative">
  {% block udc_form_loader %}
    <div id="udc-form-loading-overlay" class="udc-form-loading-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75" style="z-index:1050;">
      <div class="text-center bg-white p-3 rounded shadow-sm border" style="min-width:200px;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">{{ _('Loading form...') }}</span>
        </div>
        <div class="mt-2">{{ _('Loading form...') }}</div>
      </div>
    </div>
  {% endblock %}
  {{ h.csrf_input() }}
  {% block stages %}
    {{ h.snippet('package/snippets/stages.html', stages=stage, dataset_type=dataset_type) }}
  {% endblock %}

  <input type="hidden" name="_ckan_phase" value="dataset_new_1" />
  {# pkg_name used in 3 stage edit #}
  <input type="hidden" name="pkg_name" value="{{ data.id }}" />
  {% block errors %}{{ form.errors(error_summary) }}{% endblock %}

  <div>
    <ul class="nav nav-tabs" id="datasetTab" style="margin-bottom:10px">
      {% for level in h.config %}
        <li class="nav-item" role="presentation">
          <button class="nav-link{{" active" if loop.index == 1}}" id="{{ level["name"] }}-tab" data-bs-toggle="tab" data-bs-target="#{{ level["name"] }}" type="button" role="tab">{{ _('Maturity Level') }} {{ loop.index }}</button>
        </li>
      {% endfor %}

    </ul>
    {# CKAN Default fields #}
    <div class="tab-content" style="display:initial;">
      <script type=text/javascript>
        window.packageConfig = {{ h.config | tojson }};
        window.packageLicenses = {{ h.license_options_details(existing_license_id) | tojson }};
        window.udcLangs = {{ udc_langs | tojson }};
        window.udcDefaultLang = {{ default_lang | tojson }};
        window.udcCurrentLang = {{ __lang | tojson }};
      </script>

      {% for level in h.config %}
        {% set level_index = loop.index0 %}
        <div class="tab-pane {{ "active" if loop.index == 1 else "fade" }}" id="{{ level["name"] }}" role="tabpanel">
          <h2 style="padding-top:12px">
            {{ level["title"] }}
            <div class="btn-group btn-group-sm udc-level-toggle" role="group"
                data-level-index="{{ level_index }}" style="margin-left:.5rem;">
              {% for lang_code in udc_langs %}
                {% set label = lang_labels.get(lang_code, lang_code.upper()) %}
                <button type="button" class="btn btn-outline-secondary" data-lang="{{ lang_code }}">{{ label }}</button>
              {% endfor %}
            </div>
          </h2>
          <div class="progress" style="margin-bottom:24px">
            <div class="progress-bar" id="progress-{{loop.index}}" role="progressbar" style="width: 0%;">0%</div>
          </div>

          {% for field in level["fields"] %}
            {# Here we have the field #}
            {% if field.get("ckanField") != none %}
              {% set localized_label = locales.pick_locale(field["label"], __lang) %}
              {% set localized_short = locales.pick_locale(field.get("short_description"), __lang) %}
              {% set localized_long = locales.pick_locale(field.get("long_description"), __lang) %}

              {# ---------------------- CKAN predefined fields ---------------------- #}

              {# Add bilingual companions where applicable #}
              {% if field["ckanField"] == "title" %}
        <div class="btn-group btn-group-sm udc-lang-toggle" role="group"
          data-i18n-for="title" data-level-index="{{ level_index }}">
                  {% for lang_code in udc_langs %}
                    {% set label = lang_labels.get(lang_code, lang_code.upper()) %}
                    <button type="button" class="btn btn-outline-secondary" data-lang="{{ lang_code }}">{{ label }}</button>
                  {% endfor %}
                </div>
                {{ package_fields[field["ckanField"]](data=data, errors=errors, short_description=localized_short, long_description=localized_long) }}
                {% set translated = data.get('title_translated') if data.get('title_translated') is mapping else {} %}
                {% for lang_code in udc_langs if lang_code != default_lang %}
                  {% set label = lang_labels.get(lang_code, lang_code.upper()) %}
                  {% set lang_prefill = translated.get(lang_code, '') %}
                  {% set is_active = (lang_code == __lang) %}
                  <div class="udc-i18n-wrapper{% if not is_active %} d-none{% endif %}" data-udc-i18n-wrapper="true" data-lang="{{ lang_code }}">
                    {% call form.input('title_' ~ lang_code ~ '_dummy', label=_('Title'), id='field-title-' ~ lang_code, value=lang_prefill, classes=['control-medium'], attrs={'class': 'form-control udc-i18n-input', 'data-lang':lang_code,'data-i18n-for':'title'}) %}
                      {% if field["short_description"] %}
                        <span class="form-text">
                          {{ locales.pick_locale(field["short_description"], lang_code) or field["short_description"] }}
                        </span>
                      {% endif %}
                    {% endcall %}
                  </div>
                {% endfor %}
                <input type="hidden" name="title_translated" id="field-title_translated" data-i18n-hidden="title" value="{{ (data.get('title_translated') | tojson) if data.get('title_translated') is mapping else '' }}"/>

              {% elif field["ckanField"] == "description" %}
        <div class="btn-group btn-group-sm udc-lang-toggle" role="group"
          data-i18n-for="notes" data-level-index="{{ level_index }}">
                  {% for lang_code in udc_langs %}
                    {% set label = lang_labels.get(lang_code, lang_code.upper()) %}
                    <button type="button" class="btn btn-outline-secondary" data-lang="{{ lang_code }}">{{ label }}</button>
                  {% endfor %}
                </div>
                {{ package_fields[field["ckanField"]](data=data, errors=errors, short_description=localized_short, long_description=localized_long) }}

                {% set translated = data.get('notes_translated') if data.get('notes_translated') is mapping else {} %}
                {% for lang_code in udc_langs if lang_code != default_lang %}
                  {% set label = lang_labels.get(lang_code, lang_code.upper()) %}
                  {% set lang_prefill = translated.get(lang_code, '') %}
                  {% set is_active = (lang_code == __lang) %}
                  <div class="udc-i18n-wrapper{% if not is_active %} d-none{% endif %}" data-udc-i18n-wrapper="true" data-lang="{{ lang_code }}">
                    {% call form.markdown('notes_' ~ lang_code ~ '_dummy', label=_('Description'), id='field-notes-' ~ lang_code, value=lang_prefill, classes=['control-medium'], attrs={'class': 'form-control udc-i18n-input', 'data-lang':lang_code,'data-i18n-for':'notes'}) %}
                      {% if field["short_description"] %}
                        <span class="form-text">
                          {{ locales.pick_locale(field["short_description"], lang_code) or field["short_description"] }}
                        </span>
                      {% endif %}
                    {% endcall %}
                  </div>
                {% endfor %}
                <input type="hidden" name="notes_translated" id="field-notes_translated" data-i18n-hidden="notes" value="{{ (data.get('notes_translated') | tojson) if data.get('notes_translated') is mapping else '' }}"/>
              {% elif field["ckanField"] == "tags" %}
        <div class="btn-group btn-group-sm udc-lang-toggle" role="group"
          data-i18n-for="tags" data-level-index="{{ level_index }}">
                  {% for lang_code in udc_langs %}
                    {% set label = lang_labels.get(lang_code, lang_code.upper()) %}
                    <button type="button" class="btn btn-outline-secondary" data-lang="{{ lang_code }}">{{ label }}</button>
                  {% endfor %}
                </div>
                {{ package_fields[field["ckanField"]](data=data, errors=errors, short_description=localized_short, long_description=localized_long) }}

                {% set tags_translated_raw = data.get('tags_translated') %}
                {% if tags_translated_raw is mapping %}
                  {% set tags_hidden_value = tags_translated_raw | tojson %}
                  {% set tags_translated = tags_translated_raw %}
                {% elif tags_translated_raw %}
                  {% set tags_hidden_value = tags_translated_raw %}
                  {% set tags_translated = {} %}
                {% else %}
                  {% set tags_hidden_value = '' %}
                  {% set tags_translated = {} %}
                {% endif %}

                {% for lang_code in udc_langs if lang_code != default_lang %}
                  {% set label = lang_labels.get(lang_code, lang_code.upper()) %}
                  {% set loc_label = locales.pick_locale(field["label"], lang_code) or field["label"] %}
                  {% set short_hint = locales.pick_locale(field.get("short_description"), lang_code) %}
                  {% set long_hint = locales.pick_locale(field.get("long_description"), lang_code) %}
                  {% set is_active = (lang_code == __lang) %}
                  {% set lang_tags = tags_translated.get(lang_code, []) %}
                  {% set lang_tags_value = lang_tags | join(', ') if lang_tags else '' %}
                  <div class="udc-i18n-wrapper{% if not is_active %} d-none{% endif %}" data-udc-i18n-wrapper="true" data-lang="{{ lang_code }}">
                    {% call form.input('tags_' ~ lang_code ~ '_dummy',
                                      label=_(loc_label),
                                      id='field-tags-' ~ lang_code,
                                      placeholder=_('eg. economy, mental health, government'),
                                      value=lang_tags_value,
                                      error=errors['tags_translated'],
                                      classes=['control-full'],
                                      attrs={'class': 'udc-i18n-input', 'data-lang':lang_code, 'data-i18n-for':'tags', 'data-module': 'autocomplete', 'data-module-tags': '', 'data-module-source': '/api/2/util/tag/autocomplete?incomplete=?'}) %}
                      {% if short_hint %}
                        <span class="form-text">
                          {{ short_hint }}
                          {% if long_hint %}
                            <button type="button" style="padding:0; border:none; background:none; color:inherit" data-bs-toggle="tooltip" data-bs-placement="right" title="{{ long_hint }}">
                              <i class="fa-regular fa-circle-question"></i>
                            </button>
                          {% endif %}
                        </span>
                      {% endif %}
                    {% endcall %}
                  </div>
                {% endfor %}

                <input type="hidden" name="tags_translated" id="field-tags_translated"
                       data-i18n-hidden="tags" data-i18n-format="list"
                       value="{{ tags_hidden_value }}"/>
              {% else %}
                {{ package_fields[field["ckanField"]](data=data, errors=errors, short_description=localized_short, long_description=localized_long) }}
              {% endif %}

            {% else %}

              {% set localized_label = locales.pick_locale(field["label"], __lang) %}
              {% set localized_short = locales.pick_locale(field.get("short_description"), __lang) %}
              {% set localized_long = locales.pick_locale(field.get("long_description"), __lang) %}

              {# ---------------------- CUDC custom fields ---------------------- #}
              {% set id = "field-" + field["name"] %}

              {% if field.get("type") == "single_select" %}
                {% set opts = [] %}
                {% for option in field.get("options", []) %}
                  {% set opt_text = locales.pick_locale(option["text"], __lang) %}
                  {% do opts.append({'value': option['value'], 'text': opt_text}) %}
                {% endfor %}

                {% call form.select(
                      field["name"],
                      label=localized_label,
                      id="field-" ~ field["name"],
                      selected=data[field["name"]],
                      options=opts,
                      error=errors[field["name"]],
                      classes=['control-medium']
                ) %}
                  {% if localized_short %}
                    <span class="form-text">
                      {{ localized_short }}
                      {% if localized_long %}
                        <button type="button" style="padding:0;border:none;background:none;color:inherit"
                                data-bs-toggle="tooltip" data-bs-placement="right" title="{{ localized_long }}">
                          <i class="fa-regular fa-circle-question"></i>
                        </button>
                      {% endif %}
                    </span>
                  {% endif %}
                {% endcall %}

              {% elif field.get("type") == "multiple_select" %}
                {% set opts = [] %}
                {% for option in field.get("options", []) %}
                  {% set opt_text = locales.pick_locale(option["text"], __lang) %}
                  {% do opts.append({'value': option['value'], 'text': opt_text}) %}
                {% endfor %}

                {% call form.multiple_select(
                      field["name"],
                      label=localized_label,
                      id="field-" ~ field["name"],
                      selected=data[field["name"]],
                      options=opts,
                      error=errors[field["name"]],
                      classes=['control-medium']
                ) %}
                  {% if localized_short %}
                    <span class="form-text">
                      {{ localized_short }}
                      {% if localized_long %}
                        <button type="button" style="padding:0;border:none;background:none;color:inherit"
                                data-bs-toggle="tooltip" data-bs-placement="right" title="{{ localized_long }}">
                          <i class="fa-regular fa-circle-question"></i>
                        </button>
                      {% endif %}
                    </span>
                  {% endif %}
                {% endcall %}


              {% elif field.get("type") in ["text", None, "single_dataset", "multiple_datasets"] or field.get("type") == None %}
                {# Special handling: version relationships use structured JSON (url/title/description) #}
                {% if field["name"] == "version_dataset" %}
                  {% set vd_raw = data.get('version_dataset') %}

                  <div class="control-group mb-3">
                    <label class="control-label d-block">{{ localized_label }}</label>
                    <div class="controls" id="version-dataset-wrapper">
                      {% if localized_short %}
                        <span class="form-text">
                          {{ localized_short }}
                          {% if localized_long %}
                            <button type="button" style="padding:0;border:none;background:none;color:inherit"
                                    data-bs-toggle="tooltip" data-bs-placement="right" title="{{ localized_long }}">
                              <i class="fa-regular fa-circle-question"></i>
                            </button>
                          {% endif %}
                        </span>
                      {% endif %}

                        {# JS builds visible URL/Title/Description fields inside this wrapper.
                          Use helper to turn dict/list into JSON string safe for attribute. #}

                        <input type="hidden" name="version_dataset" id="field-version_dataset"
                             value="{{ h.udc_json_attr(vd_raw) }}" />
                    </div>
                  </div>

                {% elif field["name"] == "dataset_versions" %}
                  {% set dv_raw = data.get('dataset_versions') %}

                  <div class="control-group mb-3">
                    <label class="control-label d-block">{{ localized_label }}</label>
                    <div class="controls" id="dataset-versions-wrapper" data-udc-dataset-versions-wrapper="true">
                      {% if localized_short %}
                        <span class="form-text">
                          {{ localized_short }}
                          {% if localized_long %}
                            <button type="button" style="padding:0;border:none;background:none;color:inherit"
                                    data-bs-toggle="tooltip" data-bs-placement="right" title="{{ localized_long }}">
                              <i class="fa-regular fa-circle-question"></i>
                            </button>
                          {% endif %}
                        </span>
                      {% endif %}

                      <div class="dataset-versions-rows"></div>

                      <button type="button" class="btn btn-outline-secondary mt-2" id="dataset-versions-add" data-udc-disable-on-load>
                        {{ _('Add another version') }}
                      </button>

                          {# JS builds visible URL/Title/Description fields inside this wrapper.
                          Use helper to turn dict/list into JSON string safe for attribute. #}
                         <input type="hidden" name="dataset_versions" id="field-dataset_versions"
                            value="{{ h.udc_json_attr(dv_raw) }}" />
                    </div>
                  </div>

                {% else %}
                {% set id = "field-" + field["name"] %}
                {% set raw = data[field["name"]] %}
                {% set raw_dict = raw if raw is mapping else {} %}

                <div class="btn-group btn-group-sm udc-lang-toggle" role="group"
                    data-i18n-for="{{ field['name'] }}" data-level-index="{{ level_index }}">
                  {% for lang_code in udc_langs %}
                    {% set label = lang_labels.get(lang_code, lang_code.upper()) %}
                    <button type="button" class="btn btn-outline-secondary" data-lang="{{ lang_code }}">{{ label }}</button>
                  {% endfor %}
                </div>

                {% for lang_code in udc_langs %}
                  {% set loc_label = locales.pick_locale(field["label"], lang_code) or field["label"] %}
                  {% set short_hint = locales.pick_locale(field.get("short_description"), lang_code) %}
                  {% set long_hint = locales.pick_locale(field.get("long_description"), lang_code) %}
                  {% if raw_dict %}
                    {% set lang_prefill = raw_dict.get(lang_code) %}
                    {% if (lang_prefill is none) and lang_code == default_lang %}
                      {% set lang_prefill = raw_dict.get(default_lang) %}
                      {% if lang_prefill is none %}
                        {% set lang_prefill = (raw_dict.values()|list|first) %}
                      {% endif %}
                    {% endif %}
                  {% else %}
                    {% set lang_prefill = raw if lang_code == default_lang else '' %}
                  {% endif %}
                  {% set lang_prefill = lang_prefill or '' %}
                  {% set is_active = (lang_code == __lang) %}
                  <div class="udc-i18n-wrapper{% if not is_active %} d-none{% endif %}" data-udc-i18n-wrapper="true" data-lang="{{ lang_code }}">
                    {% call form.input(field["name"] ~ '_' ~ lang_code ~ '_dummy',
                                      label=_(loc_label),
                                      type='text', id=id ~ '-' ~ lang_code, value=lang_prefill,
                                      error=errors[field["name"]],
                                      attrs={'class': 'form-control udc-i18n-input', 'data-lang':lang_code,'data-i18n-for':field["name"]}) %}
                      {% if short_hint %}
                        <span class="form-text">
                          {{ short_hint }}
                          {% if long_hint %}
                            <button type="button" style="padding:0; border:none; background:none; color:inherit" data-bs-toggle="tooltip" data-bs-placement="right" title="{{ long_hint }}">
                              <i class="fa-regular fa-circle-question"></i>
                            </button>
                          {% endif %}
                        </span>
                      {% endif %}
                    {% endcall %}
                  </div>
                {% endfor %}

                    <input type="hidden" name="{{ field['name'] }}" id="{{ id }}"
                      data-i18n-hidden="{{ field['name'] }}"
                      value="{{ raw | tojson if raw is mapping else '' }}"/>

                    {% endif %}

              {% else %}
                {# Non-text custom fields keep default single input #}
                {% set localized_label = locales.pick_locale(field["label"], __lang) %}
                {% set localized_short = locales.pick_locale(field.get("short_description"), __lang) %}
                {% set localized_long = locales.pick_locale(field.get("long_description"), __lang) %}

                {% call form.input(field["name"], label=_(localized_label), type=field.get("type"), id=id, value=data[field["name"]], error=errors[field["name"]], classes=['control-medium']) %}
                  {% if localized_short %}
                    <span class="form-text">
                      {{ localized_short }}
                      {% if localized_long %}
                        <button type="button" style="padding:0; border:none; background:none; color:inherit" data-bs-toggle="tooltip" data-bs-placement="right" title="{{ localized_long }}">
                          <i class="fa-regular fa-circle-question"></i>
                        </button>
                      {% endif %}
                    </span>
                  {% endif %}
                {% endcall %}
              {% endif %}

            {% endif %}
          {% endfor %}
        </div>
      {% endfor %}
    </div>

  </div>

  {% block form_actions %}
    <div class="form-actions">
      {% block disclaimer %}
        <p class="action-info small">
          {%- trans -%}
          The <i>data license</i> you select above only applies to the contents
          of any resource files that you add to this dataset. By submitting
          this form, you agree to release the <i>metadata</i> values that you
          enter into the form under the
          <a href="http://opendatacommons.org/licenses/odbl/1-0/">Open Database License</a>.
          {%- endtrans -%}
        </p>
      {% endblock %}
      {% block delete_button %}
        {% if h.check_access('package_delete', {'id': data.id}) and not data.state == 'deleted' %}
          <a class="btn btn-danger pull-left disabled" data-udc-disable-on-load href="{% url_for dataset_type ~ '.delete', id=data.id %}" data-module="confirm-action" data-module-content="{{ h.humanize_entity_type('package', dataset_type, 'delete confirmation') or _('Are you sure you want to delete this dataset?') }}" aria-disabled="true" tabindex="-1">{% block delete_button_text %}{{ _('Delete') }}{% endblock %}</a>
        {% endif %}
      {% endblock %}
      {% block save_button %}
        <button class="btn btn-primary" type="submit" name="save" disabled data-udc-disable-on-load>{% block save_button_text %}{{ _('Next: Add Datasets') }}{% endblock %}</button>
      {% endblock %}
      {{ form.required_message() }}
    </div>
  {% endblock %}
</form>
