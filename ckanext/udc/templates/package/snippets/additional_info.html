{# ----------------------- helpers ----------------------- #}
{% macro pick_locale(val, lang='en') -%}
  {%- if val is mapping -%}
    {%- set out = val.get(lang) or val.get('en') or val.get('fr') -%}
    {%- if not out -%}
      {%- for k, v in val.items() -%}{%- set out = v -%}{%- break -%}{%- endfor -%}
    {%- endif -%}
    {{ out }}
  {%- else -%}
    {{ val }}
  {%- endif -%}
{%- endmacro %}

{% macro th_description (short_description="", long_description="", lang='en') %}
  {% set sd = pick_locale(short_description, lang) %}
  {% set ld = pick_locale(long_description, lang) %}
  {% if sd %}
    <div class="form-text">
      {{ sd }}
      {% if ld %}
        <button type="button" style="padding:0; border:none; background:none; color:inherit"
                data-bs-toggle="tooltip" data-bs-placement="right" title="{{ ld }}">
          <i class="fa-regular fa-circle-question"></i>
        </button>
      {% endif %}
    </div>
  {% endif %}
{% endmacro %}

{# detect current UI language (fallback to en) #}
{% set __lang = 'en' %}
{% if h.lang %}
  {% set __lang = h.lang() %}
{% endif %}

<section class="additional-info">
  {% asset 'udc/package-view'%}
  <h3>{{ _('Additional Info') }}</h3>

  <script type=text/javascript>
    window.packageConfig = {{h.config | tojson}};
  </script>

  {% set maturity_percentages = h.get_maturity_percentages(h.config, pkg_dict) %}

  <ul class="nav nav-tabs" id="datasetTab" style="margin-bottom:10px">
    {% for level in h.config %}
      <li class="nav-item" role="presentation">
        <button class="nav-link{{" active" if loop.index == 1}}"
                id="{{ level["name"] }}-tab"
                data-bs-toggle="tab"
                data-bs-target="#{{ level["name"] }}"
                type="button" role="tab">
          {{ _('Maturity Level') }} {{ loop.index }} ({{ maturity_percentages[loop.index - 1] }})
        </button>
      </li>
    {% endfor %}
  </ul>

  <div class="tab-content" style="display:initial;">
    {% for level in h.config %}
      <div class="tab-pane {{ "active" if loop.index == 1 else "fade" }}" id="{{ level["name"] }}" role="tabpanel">
        <table class="table table-striped table-bordered table-condensed">
          <thead>
            <tr>
              <th scope="col">{{ _('Field') }}</th>
              <th scope="col">{{ _('Value') }}</th>
            </tr>
          </thead>

          {# State + update time + created time (first tab only) #}
          {% if loop.index == 1 %}
            {% block package_additional_info %}
              {% if h.check_access('package_update',{'id':pkg_dict.id}) %}
                <tr>
                  <th scope="row" class="dataset-label">{{ _("State") }}</th>
                  <td class="dataset-details">{{ _(pkg_dict.state) }}</td>
                </tr>
              {% endif %}
              {% if pkg_dict.metadata_modified %}
                <tr>
                  <th scope="row" class="dataset-label">{{ _("Last Updated") }}</th>
                  <td class="dataset-details">
                    {% snippet 'snippets/local_friendly_datetime.html', datetime_obj=pkg_dict.metadata_modified %}
                  </td>
                </tr>
              {% endif %}
              {% if pkg_dict.metadata_created %}
                <tr>
                  <th scope="row" class="dataset-label">{{ _("Created") }}</th>
                  <td class="dataset-details">
                    {% snippet 'snippets/local_friendly_datetime.html', datetime_obj=pkg_dict.metadata_created %}
                  </td>
                </tr>
              {% endif %}
            {% endblock %}
          {% endif %}

          {% for field in level["fields"] %}
            {# -------- Unified field rendering (supports both custom and CKAN fields) -------- #}
            {% set field_name = field.get("name") or field.get("ckanField") %}
            {% set field_label = field.get("label") %}
            
            {% if field_label %}
              <tr>
                <th scope="row" class="dataset-label">
                  {{ pick_locale(field_label, __lang) }}
                  {{ th_description(field.get("short_description"), field.get("long_description"), __lang) }}
                </th>
                <td class="dataset-details">
                  {# Handle CKAN fields with special rendering #}
                  {% if field.get("ckanField") %}
                    
                    {% if field["ckanField"] == "source" %}
                      {% if h.is_url(pkg_dict.url) %}
                        <a href="{{ pkg_dict.url }}" rel="foaf:homepage" target="_blank" property="foaf:homepage">{{ pkg_dict.url }}</a>
                      {% else %}
                        <span property="foaf:homepage">{{ pkg_dict.url }}</span>
                      {% endif %}

                    {% elif field["ckanField"] == "author_email" %}
                      <span property="dc:creator">{{ h.mail_to(email_address=pkg_dict.author_email, name=pkg_dict.author_email) if pkg_dict.author_email else "" }}</span>

                    {% elif field["ckanField"] == "author" %}
                      <span property="dc:creator">{{ pkg_dict.author or "" }}</span>

                    {% elif field["ckanField"] == "maintainer_email" %}
                      <span property="dc:contributor">{{ h.mail_to(email_address=pkg_dict.maintainer_email, name=pkg_dict.maintainer_email) }}</span>

                    {% elif field["ckanField"] == "maintainer" %}
                      <span property="dc:contributor">{{ pkg_dict.maintainer }}</span>

                    {% elif field["ckanField"] == "version" %}
                      {{ pkg_dict.version }}

                    {% elif field["ckanField"] == "description" %}
                      {{ h.render_markdown(h.get_translated(pkg_dict, 'notes')) }}

                    {% elif field["ckanField"] == "tags" %}
                      {% set tt = pkg_dict.get('tags_translated') %}
                      {% set tag_list = [] %}
                      {% set config_default = config.get('ckan.locale_default', 'en') %}
                      
                      {% if tt is mapping %}
                        {# Try current language first, then fallback to default languages #}
                        {% set tag_list = tt.get(__lang) or tt.get(config_default) or tt.get('en') or tt.get('fr') %}
                        {% if not tag_list %}
                          {# last resort: any first list in dict #}
                          {% for _k, _v in tt.items() %}
                            {% if _v %}
                              {% set tag_list = _v %}
                              {% break %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      {% endif %}
                      
                      {% if tag_list and tag_list is iterable and tag_list is not string %}
                        {{ ', '.join(tag_list) }}
                      {% elif pkg_dict.tags or pkg_dict.tags_translated %}
                        {# fallback to tags snippet with multilingual support #}
                        {% snippet "package/snippets/tags.html", tags=pkg_dict.tags, pkg=pkg_dict %}
                      {% endif %}

                    {% elif field["ckanField"] == "license_id" %}
                      {% snippet "snippets/license.html", pkg_dict=pkg_dict, text_only=True %}

                    {% elif field["ckanField"] == "title" %}
                      {{ h.get_translated(pkg_dict, 'title') }}

                    {% elif field["ckanField"] == "organization_and_visibility" %}
                      {% if pkg_dict.organization %}
                        <a href="{{ h.url_for('organization.read', id=pkg_dict.organization.name) }}">{{ pkg_dict.organization.title or pkg_dict.organization.name }}</a>
                      {% endif %}
                    {% endif %}

                  {# Handle custom fields #}
                  {% else %}
                    {% set valToText = {} %}
                    {% if field.get("options") %}
                      {% for option in field["options"] %}
                        {% set opt_text = pick_locale(option["text"], __lang) %}
                        {% do valToText.update({option["value"]: opt_text}) %}
                      {% endfor %}
                    {% endif %}

                    {% if field["type"] == "multiple_select" %}
                      {% set values = [] %}
                      {% for selected in (pkg_dict[field_name] or '').split(',') %}
                        {% if valToText[selected] %}
                          {% do values.append(valToText[selected]) %}
                        {% endif %}
                      {% endfor %}
                      {{ ', '.join(values) }}

                    {% elif field["type"] == "single_select" %}
                      {{ valToText[pkg_dict[field_name]] }}

                    {% else %}
                      {# text / date / number etc. For text we may have a {lang: value} dict from backend
                         Special-case version_dataset / dataset_versions which now store JSON objects
                      #}
                      {% if field_name == "version_dataset" %}
                        {% set v = pkg_dict.get('version_dataset') %}
                        {% if v is mapping %}
                          {% set url = v.get('url') %}
                          {% set title = v.get('title') %}
                          {% set desc = v.get('description') %}
                          {% if url or title or desc %}
                            <div>
                              {% if url %}
                                {% set link_title = desc or title or url %}
                                <a href="{{ url }}" target="_blank" title="{{ link_title }}">
                                  {{ title or url }}
                                </a>
                              {% elif title %}
                                <span title="{{ desc or title }}">{{ title }}</span>
                              {% endif %}
                              {% if desc %}
                                <span class="visually-hidden">{{ desc }}</span>
                              {% endif %}
                            </div>
                          {% endif %}
                        {% else %}
                          {% set raw_val = pkg_dict[field_name] %}
                          {% set display_val = pick_locale(raw_val, __lang) %}
                          {% if h.is_url(display_val) %}
                            <a href="{{ display_val }}" target="_blank">{{ display_val }}</a>
                          {% else %}
                            {{ display_val }}
                          {% endif %}
                        {% endif %}

                      {% elif field_name == "dataset_versions" %}
                        {% set vlist = pkg_dict.get('dataset_versions') %}
                        {% if vlist is mapping %}
                          {% set vlist = [vlist] %}
                        {% endif %}
                        {% if vlist is sequence %}
                          <ul class="list-unstyled">
                            {% for item in vlist %}
                              {% if item is mapping %}
                                {% set url = item.get('url') %}
                                {% set title = item.get('title') %}
                                {% set desc = item.get('description') %}
                                {% if url or title or desc %}
                                  <li class="mb-1">
                                    {% if url %}
                                      {% set link_title = desc or title or url %}
                                      <a href="{{ url }}" target="_blank" title="{{ link_title }}">
                                        {{ title or url }}
                                      </a>
                                    {% elif title %}
                                      <span title="{{ desc or title }}">{{ title }}</span>
                                    {% endif %}
                                    {% if desc %}
                                      <span class="visually-hidden">{{ desc }}</span>
                                    {% endif %}
                                  </li>
                                {% endif %}
                              {% endif %}
                            {% endfor %}
                          </ul>
                        {% else %}
                          {% set raw_val = pkg_dict[field_name] %}
                          {% set display_val = pick_locale(raw_val, __lang) %}
                          {% if h.is_url(display_val) %}
                            <a href="{{ display_val }}" target="_blank">{{ display_val }}</a>
                          {% else %}
                            {{ display_val }}
                          {% endif %}
                        {% endif %}

                      {% else %}
                        {% set raw_val = pkg_dict[field_name] %}
                        {% set display_val = pick_locale(raw_val, __lang) %}
                        {% if h.is_url(display_val) %}
                          <a href="{{ display_val }}" target="_blank">{{ display_val }}</a>
                        {% else %}
                          {{ display_val }}
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          {% endfor %}

          {# CKAN Extras at the bottom #}
          {% if loop.index == 1 %}
            {% block extras scoped %}
              {% for extra in h.sorted_extras(pkg_dict.extras) %}
                {% set key, value = extra %}
                <tr rel="dc:relation" resource="_:extra{{ i }}">
                  <th scope="row" class="dataset-label" property="rdfs:label">{{ _(key|e) }}</th>
                  <td class="dataset-details" property="rdf:value">{{ value }}</td>
                </tr>
              {% endfor %}
            {% endblock %}
          {% endif %}

        </table>
      </div>
    {% endfor %}
  </div>
</section>
